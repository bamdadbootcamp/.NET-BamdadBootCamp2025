<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>افزودن کتاب</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap -->
    <link href="assets/bootstrap/css/bootstrap.rtl.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h4 m-0">افزودن کتاب</h1>
            <a href="books-list.html" class="btn btn-outline-secondary">بازگشت</a>
        </div>

        <form id="bookForm" class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">عنوان *</label>
                        <input id="title" class="form-control" required maxlength="200" placeholder="مثلاً: بوف کور" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">نویسنده *</label>
                        <input id="author" class="form-control" required maxlength="100" placeholder="مثلاً: صادق هدایت" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">ناشر</label>
                        <input id="publisher" class="form-control" maxlength="100" placeholder="مثلاً: چشمه" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">سال انتشار</label>
                        <input id="yearPublished" type="number" class="form-control" min="1000" max="3000" placeholder="مثلاً 1399" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">چاپ/ویراست</label>
                        <input id="edition" class="form-control" maxlength="50" placeholder="مثلاً: چاپ دوم" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">ISBN *</label>
                        <input id="isbn" class="form-control" required maxlength="13" placeholder="مثلاً: 978XXXXXX" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">زبان *</label>
                        <select id="languageId" class="form-select" required>
                            <option value="">انتخاب کنید...</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">دسته‌بندی</label>
                        <select id="categoryId" class="form-select">
                            <option value="">— بدون دسته —</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">قیمت فروش *</label>
                        <input id="salePrice" type="number" step="0.01" min="0" class="form-control" required placeholder="مثلاً: 250000" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block">امکان فروش</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="isAvailableForSales" checked>
                            <label class="form-check-label" for="isAvailableForSales">قابل فروش باشد</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block">امکان اجاره</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="isAvailableForRent">
                            <label class="form-check-label" for="isAvailableForRent">قابل اجاره باشد</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">قیمت اجاره</label>
                        <input id="rentPrice" type="number" step="0.01" min="0" class="form-control" placeholder="مثلاً: 50000" disabled />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">مدت اجاره (روز)</label>
                        <input id="rentalDurationDays" type="number" min="1" class="form-control" placeholder="مثلاً: 7" disabled />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">درصد تخفیف</label>
                        <input id="discountPercent" type="number" min="0" max="100" class="form-control" placeholder="0–100" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">تعداد صفحات</label>
                        <input id="pageCount" type="number" min="1" class="form-control" placeholder="مثلاً: 320" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">ابعاد</label>
                        <input id="dimensions" class="form-control" maxlength="50" placeholder="مثلاً: 14x21 cm" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">وزن (گرم)</label>
                        <input id="weightGrams" type="number" step="0.01" min="0" class="form-control" placeholder="مثلاً: 250" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">موجودی انبار</label>
                        <input id="stock" type="number" min="0" class="form-control" placeholder="مثلاً: 10" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">توضیحات</label>
                        <textarea id="description" rows="3" class="form-control" placeholder="توضیحات اختیاری"></textarea>
                    </div>

                    <div class="col-12">
                        <label class="form-label">مسیر تصویر جلد (CoverImagePath)</label>
                        <input id="coverImagePath" class="form-control" maxlength="200" placeholder="مثلاً: /uploads/covers/123.jpg" />
                    </div>

                </div>
            </div>

            <div class="card-footer d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-outline-secondary" id="btnReset">ریست</button>
                <button type="submit" class="btn btn-primary" id="btnSave">ذخیره</button>
            </div>
        </form>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
        <div id="toast" class="toast text-bg-dark border-0">
            <div class="d-flex">
                <div id="toastBody" class="toast-body">...</div>
                <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
const API_BASE       = "https://localhost:7217";              // عین Swagger
const ENDPOINT_BOOKS = `${API_BASE}/api/books`;               // POST
const ENDPOINT_LANGS = `${API_BASE}/api/languages`;           // GET -> [{id,name}]
const ENDPOINT_CATS  = `${API_BASE}/api/categories`;          // GET -> [{id,name}]

const form   = document.getElementById('bookForm');
const saveBt = document.getElementById('btnSave');
const resetBt= document.getElementById('btnReset');

const title  = document.getElementById('title');
const author = document.getElementById('author');
const publisher = document.getElementById('publisher');
const yearPublished = document.getElementById('yearPublished');
const edition  = document.getElementById('edition');
const isbn     = document.getElementById('isbn');

const languageId = document.getElementById('languageId');
const categoryId = document.getElementById('categoryId');

const salePrice = document.getElementById('salePrice');
const isAvailableForSales = document.getElementById('isAvailableForSales');
const isAvailableForRent  = document.getElementById('isAvailableForRent');
const rentPrice = document.getElementById('rentPrice');
const rentalDurationDays = document.getElementById('rentalDurationDays');

const discountPercent = document.getElementById('discountPercent');
const pageCount = document.getElementById('pageCount');
const dimensions = document.getElementById('dimensions');
const weightGrams = document.getElementById('weightGrams');
const stock = document.getElementById('stock');
const description = document.getElementById('description');
const coverImagePath = document.getElementById('coverImagePath');

const toastEl   = document.getElementById('toast');
const toastBody = document.getElementById('toastBody');
const showToast = (txt) => { toastBody.textContent = txt; new bootstrap.Toast(toastEl).show(); };

// فعال/غیرفعال کردن فیلدهای اجاره
function toggleRentFields() {
  const on = isAvailableForRent.checked;
  rentPrice.disabled = !on;
  rentalDurationDays.disabled = !on;
  if (!on) { rentPrice.value = ""; rentalDurationDays.value = ""; }
}
isAvailableForRent.addEventListener('change', toggleRentFields);

// Load dropdowns
async function loadDropdowns() {
  // Languages
  const r1 = await fetch(ENDPOINT_LANGS);
  if (!r1.ok) throw new Error("خطا در بارگذاری زبان‌ها");
  const langs = await r1.json();
  for (const l of langs) {
    const opt = document.createElement('option');
    opt.value = l.id; opt.textContent = l.name;
    languageId.appendChild(opt);
  }

  // Categories
  const r2 = await fetch(ENDPOINT_CATS);
  if (!r2.ok) throw new Error("خطا در بارگذاری دسته‌ها");
  const cats = await r2.json();
  for (const c of cats) {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.name;
    categoryId.appendChild(opt);
  }
}

function toDecimal(v) {
  if (v == null || v === "") return null;
  const n = parseFloat(String(v).replace(',', '.'));
  return isNaN(n) ? null : n;
}
function toInt(v) {
  if (v == null || v === "") return null;
  const n = parseInt(v, 10);
  return isNaN(n) ? null : n;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!form.checkValidity()) { form.reportValidity(); return; }

  // قوانین سادهٔ فرانت
  if (!languageId.value) { showToast("زبان را انتخاب کنید."); return; }
  if (isAvailableForRent.checked) {
    if (!rentPrice.value) { showToast("قیمت اجاره را وارد کنید."); return; }
    if (!rentalDurationDays.value) { showToast("مدت اجاره را وارد کنید."); return; }
  }

  const dto = {
    title: title.value.trim(),
    author: author.value.trim(),
    publisher: publisher.value.trim() || null,
    yearPublished: toInt(yearPublished.value) ?? 0,     // اگر DTO/سرور short می‌گیرد، صفر هم می‌تواند باشد
    edition: edition.value.trim() || null,
    isbn: isbn.value.trim(),

    languageId: toInt(languageId.value),
    categoryId: categoryId.value ? toInt(categoryId.value) : null,

    salePrice: toDecimal(salePrice.value) ?? 0,
    isAvailableForSales: isAvailableForSales.checked,

    isAvailableForRent: isAvailableForRent.checked,
    rentPrice: isAvailableForRent.checked ? (toDecimal(rentPrice.value) ?? 0) : 0,
    rentalDurationDays: isAvailableForRent.checked ? (toInt(rentalDurationDays.value) ?? 0) : 0,

    discountPercent: toInt(discountPercent.value) ?? 0,
    pageCount: toInt(pageCount.value) ?? 0,
    dimensions: dimensions.value.trim() || null,
    weightGrams: toDecimal(weightGrams.value) ?? 0,
    stock: toInt(stock.value) ?? 0,
    description: description.value.trim() || null,
    coverImagePath: coverImagePath.value.trim() || null
  };

  try {
    saveBt.disabled = true; saveBt.textContent = "در حال ذخیره...";
    const res = await fetch(ENDPOINT_BOOKS, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dto)
    });

    if (res.status === 201 || res.status === 200) {
      showToast("کتاب با موفقیت افزوده شد.");
      // پاک‌سازی فرم
      form.reset();
      toggleRentFields();
      languageId.value = ""; categoryId.value = "";
    } else {
      const t = await res.text();
      showToast(t || `خطا: ${res.status}`);
    }
  } catch (err) {
    console.error(err);
    showToast("عدم دسترسی به سرور");
  } finally {
    saveBt.disabled = false; saveBt.textContent = "ذخیره";
  }
});

resetBt.addEventListener('click', () => {
  form.reset();
  toggleRentFields();
  languageId.value = ""; categoryId.value = "";
});

// init
toggleRentFields();
loadDropdowns().catch(e => showToast(e.message));
    </script>
</body>
</html>
