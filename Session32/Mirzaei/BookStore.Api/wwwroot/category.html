<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>دسته‌بندی کتاب‌ها</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 -->
    <link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body style="background: #f7fff7">
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h4 m-0">دسته‌بندی‌ها</h1>
        <button class="btn btn-primary" id="btnAdd">
          <i class="bi bi-plus-lg"></i> افزودن دسته
        </button>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-auto">
          <input id="search" class="form-control" placeholder="جستجو..." />
        </div>
        <div class="col-auto">
          <button id="btnRefresh" class="btn btn-outline-secondary">
            بارگذاری مجدد
          </button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="tbl">
            <thead class="table-light">
              <tr>
                <th style="width: 72px">#</th>
                <th>نام دسته</th>
                <th style="width: 140px" class="text-center">تعداد کتاب</th>
                <th style="width: 160px" class="text-center">عملیات</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- rows -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Toast -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
        <div
          id="toast"
          class="toast align-items-center text-bg-dark border-0"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="d-flex">
            <div class="toast-body" id="toastBody">...</div>
            <button
              type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"
            ></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="catModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="catForm">
          <div class="modal-header">
            <h5 class="modal-title" id="catModalTitle">افزودن دسته</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="catId" />
            <div class="mb-3">
              <label class="form-label">نام دسته</label>
              <input
                id="catName"
                class="form-control"
                required
                maxlength="100"
                placeholder="مثلاً: رمان"
              />
            </div>
           
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              type="button"
              data-bs-dismiss="modal"
            >
              انصراف
            </button>
            <button class="btn btn-primary" type="submit">ذخیره</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div class="modal fade" id="delModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title">حذف دسته</h6>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            آیا از حذف «<span id="delName"></span>» مطمئن هستید؟
            <input type="hidden" id="delId" />
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              انصراف
            </button>
            <button class="btn btn-danger" id="btnConfirmDelete">حذف</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap + Icons -->
    <script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <script>
      // ===== تنظیمات =====
      const API_BASE = "https://localhost:7217"; 
      const ENDPOINT = `${API_BASE}/api/categories`;

      // ===== المان‌ها =====
      const tbody = document.getElementById("tbody");
      const search = document.getElementById("search");
      const btnAdd = document.getElementById("btnAdd");
      const btnRefresh = document.getElementById("btnRefresh");

      const catModalEl = document.getElementById("catModal");
      const catModal = new bootstrap.Modal(catModalEl);
      const catForm = document.getElementById("catForm");
      const catId = document.getElementById("catId");
      const catName = document.getElementById("catName");
      
      const catModalTitle = document.getElementById("catModalTitle");

      const delModal = new bootstrap.Modal(document.getElementById("delModal"));
      const delId = document.getElementById("delId");
      const delName = document.getElementById("delName");

      const toastEl = document.getElementById("toast");
      const toastBody = document.getElementById("toastBody");
      const showToast = (txt) => {
        toastBody.textContent = txt;
        new bootstrap.Toast(toastEl).show();
      };

      // ===== State =====
      let categories = []; // { id, name, booksCount }

      // ===== API helpers =====
      async function apiGet() {
        const r = await fetch(ENDPOINT);
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }
      async function apiPost(dto) {
        const r = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto),
        });
        if (!r.ok) throw new Error(await r.text());
      }
      async function apiPut(id, dto) {
        const r = await fetch(`${ENDPOINT}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto),
        });
        if (!r.ok) throw new Error(await r.text());
      }
      async function apiDelete(id) {
        const r = await fetch(`${ENDPOINT}/${id}`, { method: "DELETE" });
        if (!r.ok) throw new Error(await r.text());
      }

      // ===== UI render =====
      function render(list) {
        tbody.innerHTML = "";
        list.forEach((c, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHtml(c.name)}</td>
      <td class="text-center">${c.booksCount ?? 0}</td>
      <td class="text-center">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" data-action="edit" data-id="${
            c.id
          }"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-action="del" data-id="${
            c.id
          }" data-name="${escapeHtml(
            c.name
          )}"><i class="bi bi-trash"></i></button>
        </div>
      </td>`;
          tbody.appendChild(tr);
        });
      }

      // ساده‌سازی جست‌وجو
      function applyFilter() {
        const q = search.value.trim().toLowerCase();
        const filtered = !q
          ? categories
          : categories.filter((c) => c.name.toLowerCase().includes(q));
        render(filtered);
      }

      // ===== Events =====
      btnAdd.addEventListener("click", () => {
        catId.value = "";
        catName.value = "";       
        catModalTitle.textContent = "افزودن دسته";
        catModal.show();
      });

      btnRefresh.addEventListener("click", load);

      catForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const dto = { name: catName.value.trim() };
        try {
          if (catId.value) {
            await apiPut(catId.value, dto);
            showToast("ویرایش شد.");
          } else {
            await apiPost(dto);
            showToast("افزوده شد.");
          }
          catModal.hide();
          await load();
        } catch (err) {
          showToast("خطا: " + err.message);
        }
      });

      // اکشن‌های جدول: ویرایش/حذف
      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === "edit") {
          const cat = categories.find((x) => String(x.id) === String(id));
          if (!cat) return;
          catId.value = cat.id;
          catName.value = cat.name;
          
          catModalTitle.textContent = "ویرایش دسته";
          catModal.show();
        }
        if (action === "del") {
          delId.value = id;
          delName.textContent = btn.dataset.name || "";
          delModal.show();
        }
      });

      document
        .getElementById("btnConfirmDelete")
        .addEventListener("click", async () => {
          try {
            await apiDelete(delId.value);
            delModal.hide();
            showToast("حذف شد.");
            await load();
          } catch (err) {
            showToast("خطا: " + err.message);
          }
        });

      search.addEventListener("input", applyFilter);

      // ===== Load =====
      async function load() {
        try {
          const data = await apiGet();
          // انتظار پاسخ: [{ id, name, booksCount? }]
          categories = Array.isArray(data) ? data : [];
          applyFilter();
        } catch (err) {
          showToast("خطا در بارگذاری: " + err.message);
        }
      }

      // XSS-safe
      function escapeHtml(s) {
        return (
          s?.replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#039;",
              }[m])
          ) ?? ""
        );
      }

      load();
    </script>
  </body>
</html>
